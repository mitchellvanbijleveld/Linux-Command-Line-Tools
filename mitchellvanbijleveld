#!/bin/bash
SELF_VAR_UTILITY="mitchell"
SELF_VAR_UTILITY_SCRIPT="vanbijleveld"

####################################################################################################
####################################################################################################
# GLOBAL VARIABLES
####################################################################################################
export VAR_BIN_INSTALL_DIR=$(dirname $(realpath $0))
export VAR_BIN_CONFIG_DIR="/etc/mitchellvanbijleveld/Linux-Command-Line-Tools"
export VAR_BIN_TEMP_DIR="/tmp/mitchellvanbijleveld/Linux-Command-Line-Tools"

VAR_BIN_ARGUMENTS_STRING="$@"
VAR_BIN_ARGUMENTS=$(echo "$@" | sed "s/--[^ ]*//gi; s/^ *//; s/  */ /g; s/ *$//") # replace flags, leading spaces, more than two spaces, and trailing spaces
export VAR_UTILITY=$(echo "$VAR_BIN_ARGUMENTS" | awk '{print $1}')
export VAR_UTILITY_SCRIPT=$(echo "$VAR_BIN_ARGUMENTS" | awk '{print $2}')
if [[ $VAR_UTILITY != "" ]] && [[ $VAR_UTILITY_SCRIPT != "" ]]; then
    VAR_UTILITY_SCRIPT_ARGUMENTS=$(echo "$@" | sed "s/--DEBUG//gi; s/$VAR_UTILITY//i; s/$VAR_UTILITY_SCRIPT//i; s/^ *//; s/  */ /g; s/ *$//")
fi

if [[ $(echo $@ | tr '[:lower:]' '[:upper:]') =~ (^|[[:space:]])--DEBUG([[:space:]]|$) ]]; then
    export VAR_SCRIPT_DEBUG=1
fi
####################################################################################################
# GLOBAL VARIABLES
####################################################################################################
####################################################################################################





####################################################################################################
####################################################################################################
# FUNCTIONS
####################################################################################################
PrintMessage(){
    # $1 = Log Level
    # $2 = Utility
    # $3 = Script
    # $4 = Message
    if [[ "$1" == "" ]] && [[ "$2" == "" ]] && [[ "$3" == "" ]] && [[ "$4" == "" ]]; then ### IF ALL ARGUMENTS ARE EMPTY
        case $VAR_SCRIPT_DEBUG in
            1) return 0;; # Print nothing in debugging mode
            *) echo; return 0;; # Print empty line in *** non *** debugging mode
        esac
    elif [[ "$1" != "" ]] && [[ "$2" != "" ]] && [[ "$3" != "" ]] && [[ "$4" != "" ]]; then ### IF ALL ARGUMENTS HAVE A VALUE
        case $VAR_SCRIPT_DEBUG in
            1) echo $(date +"%Y-%m-%d %H:%M:%S") "$(printf "%-38s" "$2/$3")" "[$(printf "%6s" "$1")]" ":" "$4"; return 0;;
            *) 
                case $1 in
                    "DEBUG" | "CONFIG" | "PRERUN") return 0;;
                    "INFO") echo "$4"; return 0;;
                esac
                ;;
        esac
    fi
}
export -f PrintMessage

EvalFromFile(){
    # $1 = NAME OF VARIABLE
    # $2 = FILE PATH
    VAR_LINE_TO_BE_EVALUATED=$(grep "^$1=" "$2")
    eval "$VAR_LINE_TO_BE_EVALUATED"
}
export -f EvalFromFile


# Function die_UtilityNotFound()
# Exits the script if utility does not exist.
die_UtilityNotFound () {
    # $1 = MESSAGE
    PrintMessage "INFO" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "$1"
    PrintMessage "INFO" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "The bin '$(basename $0)' supports the following utilities:"
    PrintMessage "DEBUG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Searching for utilities in '$VAR_BIN_INSTALL_DIR'..."
    for var_utility_dir in "$VAR_BIN_INSTALL_DIR"/*; do
        if [[ -d  "$var_utility_dir" ]]; then
            var_utility=$(basename $var_utility_dir)
            PrintMessage "INFO" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "  - $var_utility"
        fi
    done
    exit 1
}

die_UtilityScriptNotFound (){
    # $1 = MESSAGE
    PrintMessage "INFO" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "$1"
    PrintMessage "INFO" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "The utility '$VAR_UTILITY' supports the following scripts:"
    PrintMessage "DEBUG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Searching for scripts in '$VAR_UTILITY_FOLDER_PATH'..."
    for var_utility_script_real_path in "$VAR_UTILITY_FOLDER_PATH"/*; do
        if [[ -f  "$var_utility_script_real_path" ]]; then
            var_utility_script=$(basename $var_utility_script_real_path)
            PrintMessage "INFO" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "  - ${var_utility_script%.sh}"
        fi
    done
    exit 1
}
####################################################################################################
# FUNCTIONS
####################################################################################################
####################################################################################################




####################################################################################################
####################################################################################################
# PRINT CONFIG PART ONE
####################################################################################################
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "BIN INSTALLATION DIRECTORY  : $VAR_BIN_INSTALL_DIR"
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "BIN CONFIGURATION DIRECTORY : $VAR_BIN_CONFIG_DIR"
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "BIN TEMPORARY DIRECTORY     : $VAR_BIN_TEMP_DIR"

PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "BIN ARGUMENT LIST STRING    : '$VAR_BIN_ARGUMENTS_STRING'"
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "BIN ARGUMENTS WITHOUT FLAGS : '$VAR_BIN_ARGUMENTS'"
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "UTILITY                     : '$VAR_UTILITY'"
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "UTILITY SCRIPT              : '$VAR_UTILITY_SCRIPT'"
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "UTILITY SCRIPT ARGUMENTS    : '$VAR_UTILITY_SCRIPT_ARGUMENTS'"
####################################################################################################
# PRINT CONFIG PART ONE
####################################################################################################
####################################################################################################

# Check Debug
for BinArgument in $(echo $@ | tr '[:lower:]' '[:upper:]'); do
    PrintMessage "DEBUG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Checking argument $BinArgument"
    case $BinArgument in
    "--DEBUG") PrintMessage "DEBUG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "DEBUG should already be enabled...";;
    *) PrintMessage "DEBUG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Ignoring '$BinArgument'...";;
    esac
done



####################################################################################################
####################################################################################################
# PRE START CHECKS
####################################################################################################
PrintMessage "PRERUN" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Checking if VAR_UTILITY has a value..."
    if [[ "$VAR_UTILITY" == "" ]]; then
        #die_UtilityNotFound "No utility specified!"
        "$(which bash)" "$VAR_BIN_INSTALL_DIR/InteractiveShell/Start.sh"
        exit 0
    fi
PrintMessage "PRERUN" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Using the 'find' command to set the actual directory path for VAR_UTILITY_FOLDER_PATH..."
    if [[ $(echo $VAR_UTILITY | tr '[:lower:]' '[:upper:]') == "HELP" ]]; then
        export VAR_UTILITY_FOLDER_PATH=$(find "$VAR_BIN_INSTALL_DIR/Help" -iname "$VAR_UTILITY" -type d -print)
    elif [[ $(echo $VAR_UTILITY | tr '[:lower:]' '[:upper:]') == "INTERACTIVESHELL" ]]; then
        export VAR_UTILITY_FOLDER_PATH=$(find "$VAR_BIN_INSTALL_DIR/InteractiveShell" -iname "$VAR_UTILITY" -type d -print)
    else
        export VAR_UTILITY_FOLDER_PATH=$(find "$VAR_BIN_INSTALL_DIR" -path "$VAR_BIN_INSTALL_DIR/Help" -prune -o -path "$VAR_BIN_INSTALL_DIR/InteractiveShell" -prune -o -iname "$VAR_UTILITY" -type d -print)
    fi
PrintMessage "PRERUN" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Checking if VAR_UTILITY_FOLDER_PATH is an existing directory..."
    if ! [[ -d $VAR_UTILITY_FOLDER_PATH ]]; then
        die_UtilityNotFound "The '$VAR_UTILITY' utility was not found!"
    fi



PrintMessage "PRERUN" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Checking if VAR_UTILITY_SCRIPT has a value..."
    if [[ "$VAR_UTILITY_SCRIPT" == "" ]]; then
        die_UtilityScriptNotFound "No script specified!"
    fi
PrintMessage "PRERUN" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Using the 'find' command to set the actual VAR_UTILITY_SCRIPT_REAL_PATH..."
    VAR_UTILITY_SCRIPT_REAL_PATH=$(find $VAR_UTILITY_FOLDER_PATH -maxdepth 1 -iname "$VAR_UTILITY_SCRIPT.sh" -type f)
PrintMessage "PRERUN" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Checking if VAR_UTILITY_SCRIPT_REAL_PATH is an existing file..."
    if ! [[ -f $VAR_UTILITY_SCRIPT_REAL_PATH ]]; then
        die_UtilityScriptNotFound "The '$VAR_UTILITY_SCRIPT' script was not found within the '$VAR_UTILITY' utility!"
    fi
####################################################################################################
# PRE START CHECKS
####################################################################################################
####################################################################################################



####################################################################################################
####################################################################################################
# PRINT CONFIG PART TWO
####################################################################################################
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Utility Folder Path         : '$VAR_UTILITY_FOLDER_PATH'"
PrintMessage "CONFIG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Utility Script File Path    : '$VAR_UTILITY_SCRIPT_REAL_PATH'"
####################################################################################################
# PRINT CONFIG PART TWO
####################################################################################################
####################################################################################################


















# Check Dependencies
PrintMessage "DEBUG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Fetching dependencies from Utility Script '$VAR_UTILITY_SCRIPT_REAL_PATH'..."
EvalFromFile "VAR_SCRIPT_REQUIRED_COMMAND_LINE_TOOLS" "$VAR_UTILITY_SCRIPT_REAL_PATH"
PrintMessage "DEBUG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Starting dependency check for dependencies '$VAR_SCRIPT_REQUIRED_COMMAND_LINE_TOOLS'..."
"$(which bash)" "$VAR_BIN_INSTALL_DIR/bin/CheckDependencies.sh" "$VAR_SCRIPT_REQUIRED_COMMAND_LINE_TOOLS" || { exit 1; }

# Export vars usable by the script
EvalFromFile "VAR_UTILITY" "$VAR_UTILITY_SCRIPT_REAL_PATH"
EvalFromFile "VAR_UTILITY_SCRIPT" "$VAR_UTILITY_SCRIPT_REAL_PATH"
export VAR_UTILITY_SCRIPT_CONFIG_DIR="$VAR_BIN_CONFIG_DIR/$VAR_UTILITY/$VAR_UTILITY_SCRIPT"
export VAR_UTILITY_SCRIPT_TEMP_DIR="$VAR_BIN_TEMP_DIR/$VAR_UTILITY/$VAR_UTILITY_SCRIPT"

# Making necessary directories
mkdir -p "$VAR_UTILITY_SCRIPT_CONFIG_DIR"
mkdir -p "$VAR_UTILITY_SCRIPT_TEMP_DIR"





####################################################################################################
####################################################################################################
# MAIN SCRIPT
####################################################################################################





# START THE UTILITY SCRIPT WITH THE GIVEN ARGUMENTS (IF ANY)
PrintMessage "DEBUG" "$SELF_VAR_UTILITY" "$SELF_VAR_UTILITY_SCRIPT" "Starting Utility Script '$(ls $VAR_UTILITY_SCRIPT_REAL_PATH)' [$VAR_UTILITY_SCRIPT_ARGUMENTS]..."
"$(which bash)" "$VAR_UTILITY_SCRIPT_REAL_PATH" $VAR_UTILITY_SCRIPT_ARGUMENTS
####################################################################################################
# MAIN SCRIPT
####################################################################################################
####################################################################################################